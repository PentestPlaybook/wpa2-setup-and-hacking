# 1. Enable SSH
sudo systemctl enable ssh
sudo systemctl start ssh

# 2. Configure NetworkManager to manage all interfaces
sudo tee /etc/NetworkManager/NetworkManager.conf >/dev/null <<'EOF'
[main]
plugins=keyfile,ifupdown
dns=default
managed=true

[ifupdown]
managed=true
EOF

# 3. Configure NetworkManager to NOT manage wlan0 (for AP), but manage everything else
sudo tee /etc/NetworkManager/conf.d/99-unmanaged-devices.conf >/dev/null <<'EOF'
[keyfile]
unmanaged-devices=interface-name:wlan0
EOF

# 4. Remove/disable any eth0 configuration in /etc/network/interfaces.d/
sudo rm -f /etc/network/interfaces.d/eth0

# 5. Create systemd service to force eth0 management on boot
sudo tee /etc/systemd/system/nm-manage-eth0.service >/dev/null <<'EOF'
[Unit]
Description=Force NetworkManager to manage eth0
After=NetworkManager.service
Wants=NetworkManager.service

[Service]
Type=oneshot
ExecStart=/usr/bin/nmcli device set eth0 managed yes
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 6. Create systemd service to configure wlan0 for AP on boot
sudo tee /etc/systemd/system/wlan0-ap-setup.service >/dev/null <<'EOF'
[Unit]
Description=Configure wlan0 for Access Point
After=network.target
Before=hostapd.service dnsmasq.service

[Service]
Type=oneshot
ExecStart=/usr/bin/rfkill unblock wifi
ExecStart=/usr/sbin/ip link set wlan0 down
ExecStart=/bin/sleep 1
ExecStart=/usr/sbin/ip link set wlan0 up
ExecStart=/usr/sbin/ip addr flush dev wlan0
ExecStart=/usr/sbin/ip addr add 192.168.10.1/24 dev wlan0
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 7. Enable both systemd services
sudo systemctl daemon-reload
sudo systemctl enable nm-manage-eth0.service
sudo systemctl enable wlan0-ap-setup.service

# 8. Create eth0 connection with custom DNS
sudo nmcli connection add type ethernet ifname eth0 con-name eth0
sudo nmcli connection modify eth0 ipv4.dns "1.1.1.1 8.8.8.8"
sudo nmcli connection modify eth0 ipv4.ignore-auto-dns yes
sudo nmcli connection modify eth0 ipv4.method auto
sudo nmcli connection modify eth0 ipv6.ignore-auto-dns yes
sudo nmcli connection modify eth0 ipv6.method auto

# 9. Restart NetworkManager
sudo systemctl restart NetworkManager

# 10. Force eth0 to be managed NOW (before reboot)
sudo nmcli device set eth0 managed yes

# 11. Reboot to confirm persistence
sudo reboot

# 12. Verify everything works
nmcli device status
ping -c2 google.com
cat /etc/resolv.conf

# 13. Update system
sudo apt update && sudo apt -y upgrade

# 14. Configure WPA2 access point
curl https://raw.githubusercontent.com/PentestPlaybook/wpa2-setup-and-hacking/refs/heads/main/wpa2-setup.sh -o wpa2-setup.sh
chmod +x wpa2-setup.sh
sudo ./wpa2-setup.sh

# 15. Reboot and verify everything works
sudo reboot
nmcli device status
ping -c2 google.com
cat /etc/resolv.conf
sudo systemctl status hostapd dnsmasq
